<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AI PR GITHUB Dashboard</title>
  <style>
    :root {
      --bg: #0f172a;
      --card: #1e293b;
      --accent: #38bdf8;
      --text: #f1f5f9;
      --green: #4ade80; /* Added for low risk / merged */
      --red: #f87171; /* Added for high risk / closed */
      --yellow: #facc15; /* Added for open status */
    }
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: system-ui, sans-serif; }
    body { 
        background: var(--bg); 
        color: var(--text); 
        padding: 2rem; 
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
    }
    h1 { text-align: center; margin-bottom: 2rem; font-size: 2.5rem; color: var(--accent); }
    .grid { 
        display: grid; 
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); 
        gap: 1.5rem; 
        width: 100%;
        max-width: 1200px;
    }
    .card { 
        background: var(--card); 
        padding: 1.5rem; 
        border-radius: 1rem; 
        box-shadow: 0 8px 16px rgba(0,0,0,0.5); 
    }
    .card p { margin-bottom: 0.5rem; }
    .card strong { color: var(--accent); margin-right: 0.5rem; }
    .card h2 { font-size: 1.4rem; margin-bottom: 1rem; color: var(--accent); border-bottom: 2px solid rgba(56, 189, 248, 0.3); padding-bottom: 0.5rem; }
    .btn { display: inline-block; background: var(--accent); color: var(--bg); padding: 0.6rem 1.2rem; border-radius: 0.5rem; text-decoration: none; margin-top: 1rem; font-weight: 700; transition: background 0.2s; }
    .btn:hover { background: #7dd3fc; }
    footer { text-align: center; margin-top: 3rem; padding-top: 1rem; border-top: 1px solid var(--card); font-size: 0.9rem; opacity: 0.7; width: 100%; max-width: 1200px; }

    /* New status colors */
    .risk-low { color: var(--green); font-weight: 700; }
    .risk-high { color: var(--red); font-weight: 700; }
    .status-merged { color: var(--green); font-weight: 700; }
    .status-open { color: var(--yellow); font-weight: 700; }
    .status-closed { color: var(--red); font-weight: 700; }
  </style>
</head>
<body>
  <h1>AI PR GITHUB Dashboard</h1>

  <div class="grid">
    <div class="card">
      <h2>Latest PR Summary</h2>
      <p id="prTitle">Loading...</p>
      <p><strong>Author:</strong> <span id="prAuthor">Loading...</span></p>
      <p><strong>Files/Changes:</strong> <span id="summary">Loading...</span></p>
      <a href="#" id="prLink" class="btn" target="_blank">View PR</a>
    </div>

    <div class="card">
      <h2>Metrics</h2>
      <p><strong>Risk Score:</strong> <span id="riskScore">Loading...</span></p>
      <p><strong>Bandit Issues:</strong> <span id="banditIssues">Loading...</span></p>
      <p><strong>Tests Failed:</strong> <span id="testsFailed">Loading...</span></p>
    </div>

    <div class="card">
      <h2>PR Status</h2>
      <p><strong>State:</strong> <span id="stateStatus">Loading...</span></p>
      <p><strong>Merged:</strong> <span id="mergedStatus">Loading...</span></p>
      <p><strong>Auto-Merge:</strong> <span id="autoMergeStatus">Loading...</span></p>
    </div>
  </div>

  <footer>
    © 2025 AI-PR-GITHUB | Built with ♥ for GitHub Pages
  </footer>

  <script>
    const dataUrl = "./dashboard.json"; 
    const repoBaseUrl = "https://github.com/icryptologic/GITHUB-Native-PR-AI/pull/";

    async function loadMetrics() {
      try {
        const res = await fetch(dataUrl);
        if (!res.ok) throw new Error(`HTTP error: ${res.status}`);

        const dataArray = await res.json();
        if (!Array.isArray(dataArray) || dataArray.length === 0) throw new Error("No PR data");

        // CORRECTED: Get the FIRST element (index 0) because the workflow is sorting newest first.
        const latestPR = dataArray[0];

        // Helper functions for readability
        const getElement = (id) => document.getElementById(id);
        const setContent = (id, content) => getElement(id).textContent = content;
        const setClass = (id, className) => getElement(id).className = className;

        // PR Details
        setContent('prTitle', `#${latestPR.id} – ${latestPR.title}`);
        setContent('prAuthor', `@${latestPR.author}`);
        // Combined files, additions, and deletions into one summary element
        setContent('summary', `${latestPR.changed_files} files, +${latestPR.additions} / -${latestPR.deletions}`);
        getElement('prLink').href = `${repoBaseUrl}${latestPR.id}`;
        getElement('prLink').textContent = `View PR #${latestPR.id}`;

        // Metrics
        const riskScoreElement = getElement('riskScore');
        riskScoreElement.textContent = `${latestPR.risk} / 100`;
        // Apply color based on risk score (using string to number conversion)
        const risk = parseInt(latestPR.risk);
        riskScoreElement.className = risk > 30 ? 'risk-high' : 'risk-low';
        
        // Updated IDs to match the new structure
        setContent('banditIssues', latestPR.bandit || 0);
        setContent('testsFailed', latestPR.tests_failed || 0);
        
        // Status
        const mergedStatus = latestPR.merged === "true" ? "✅ True" : "❌ False";
        setContent('mergedStatus', mergedStatus);
        
        const stateStatusElement = getElement('stateStatus');
        const state = latestPR.state ? latestPR.state.toUpperCase() : 'N/A';
        stateStatusElement.textContent = state;
        if (state === 'OPEN') setClass('stateStatus', 'status-open');
        else if (state === 'CLOSED') setClass('stateStatus', 'status-closed');

        // Display Auto-Merge Status (Using the new field from the YAML file)
        const autoMerge = latestPR.auto_merged === "true" ? "🟢 ELIGIBLE" : "🔴 REQUIRES MANUAL REVIEW";
        setContent('autoMergeStatus', autoMerge);


      } catch (err) {
        console.error("Dashboard error:", err);
        document.getElementById('prTitle').textContent = "⚠️ Error fetching data";
        document.getElementById('prAuthor').textContent = "Check GitHub Actions logs.";
        document.getElementById('prLink').textContent = "Refresh Page";
        document.getElementById('prLink').href = "#";
      }
    }

    loadMetrics();
  </script>
</body>
</html>
